"""This rule calculates total immune escape values for each strain on the tree
based on mutations relative to an immunizing strain. This requires deep-mutational
scanning data, as a csv, which shows the effect of each mutation on neutralization.
Only positive escape values—e.g., mutations which provide neutralization resistance—
are summed; thus, all total escape values will be greater than or equal to 0."""
rule escape:
    message: "calculating immune escape values"
    input:
        nt_file = "results/nt-muts_{subtype}_ha.json",
        escape_summary = "data/escape_summary.csv"
    output:
        escape_annotations = "results/escape-annotations_{subtype}_ha.json",
        mutation_summary = "results/escape-mutations-summary_{subtype}_ha.json",
        mutation_list = "results/escape-mutations-list_{subtype}_ha.json"
    shell:
        """
        python scripts/annotate-escape.py \
            --input_nt_file {input.nt_file} \
            --input_escape_summary_file {input.escape_summary} \
            --output_total_escape_file {output.escape_annotations} \
            --output_mutation_summary_file {output.mutation_summary} \
            --output_mutation_list_file {output.mutation_list} \
            --exclude_cleavage_site True
        """